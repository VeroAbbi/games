<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drink & Degree ‚Äì Elisa Edition</title>
  <meta name="description" content="Gioco di carte online: pesca, mescola, modifica le carte e gioca a turni." />
  <style>
    :root{
      --bg:#0b0c10; /* scuro elegante */
      --card:#11131a;
      --ink:#e6e6ef;
      --muted:#a9adc1;
      --accent:#7c5cff;
      --accent-2:#00d1b2;
      --danger:#ff5c7c;
      --ok:#10c060;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, #1a1d29 0%, var(--bg) 60%);
      color:var(--ink);
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
      gap:16px;
    }
    header{width:100%; max-width:960px; padding:16px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px}
    header h1{font-size: clamp(18px, 3.6vw, 28px); margin:0; letter-spacing:.3px}
    header .row{display:flex; gap:8px; flex-wrap:wrap}

    .pill{font-size:12px; color:var(--muted)}

    main{width:100%; max-width:960px; padding:0 20px 20px; display:grid; grid-template-columns: 1fr; gap:16px}

    .board{display:grid; grid-template-columns: 1fr; gap:16px}

    .card{
      min-height: 46vh;
      border-radius: var(--radius);
      background: linear-gradient(180deg, #15192b 0%, #0f1220 100%);
      box-shadow: var(--shadow);
      padding: 24px; display:flex; align-items:center; justify-content:center; text-align:center;
      position:relative; isolation:isolate; overflow:hidden;
    }
    .card::after{
      content:""; position:absolute; inset:-30% -10% auto auto; width:60%; height:120%;
      background: radial-gradient(500px 300px at 75% 0%, rgba(124,92,255,.15), transparent 60%),
                  radial-gradient(300px 200px at 90% 40%, rgba(0,209,178,.12), transparent 65%);
      transform: rotate(-8deg); pointer-events:none; z-index:-1;
    }
    .card .text{font-size: clamp(20px, 3.5vw, 32px); line-height:1.3}
    .card .index{position:absolute; top:14px; left:16px; font-size:12px; color:var(--muted)}

    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    button{
      appearance:none; border:none; cursor:pointer; border-radius:14px; padding:12px 16px; font-weight:600;
      background:#1b1f33; color:var(--ink); box-shadow: 0 8px 20px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.06);
      transition: transform .05s ease, filter .2s ease, background .2s ease;
    }
    button:hover{filter: brightness(1.15)}
    button:active{transform: translateY(1px)}
    .primary{background: linear-gradient(180deg, #775cff, #6a4eff);}
    .good{background: linear-gradient(180deg, #1cc58a, #13b37d);} 
    .danger{background: linear-gradient(180deg, #ff6a8a, #f1547a);} 
    .ghost{background:#14172a}

    .bar{display:flex; align-items:center; gap:10px; justify-content:space-between; flex-wrap:wrap}
    .bar .left, .bar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .players{display:flex; gap:8px; flex-wrap:wrap}
    .player-chip{padding:8px 10px; border-radius:999px; background:#151935; color:#cfd3ff; font-weight:600}
    .player-chip.active{outline:2px solid var(--accent)}

    details{
      background:#0f1220; border-radius:16px; padding:10px 12px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    summary{cursor:pointer; font-weight:700; color:#d7dbff}
    .editor{display:grid; grid-template-columns: 1fr; gap:12px; margin-top:8px}
    textarea{width:100%; min-height:180px; resize:vertical; border-radius:12px; padding:12px; background:#0b0e1a; color:var(--ink); border:1px solid #232744}
    input[type="text"]{background:#0b0e1a; color:var(--ink); border:1px solid #232744; border-radius:10px; padding:10px}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; gap:8px; flex-wrap:wrap}

    footer{opacity:.8; font-size:12px; padding-bottom:24px}
    a{color:#c6b6ff}

    @media (min-width: 880px){
      .board{grid-template-columns: 1.2fr .8fr}
      .side{position:sticky; top:12px; align-self:start}
    }
  </style>
</head>
<body>
  <header>
    <h1>üéìü•Ç Drink & Degree ‚Äì Elisa Edition</h1>
    <div class="row">
      <span class="pill">Versione: 1.0</span>
      <button id="btn-full" class="ghost" title="Schermo intero">‚õ∂</button>
    </div>
  </header>

  <main>
    <section class="board">
      <div>
        <div class="card" id="card">
          <div class="index" id="cardIndex">‚Äî</div>
          <div class="text" id="cardText">Premi ‚ÄúPesca carta‚Äù per iniziare ‚ú®</div>
        </div>
        <div class="bar">
          <div class="left controls">
            <button id="draw" class="primary">üé¥ Pesca carta</button>
            <button id="undo" class="ghost" title="Torna alla carta precedente">‚Ü©Ô∏é Indietro</button>
            <button id="reshuffle" class="danger" title="Rimescola il mazzo e ricomincia">üîÑ Rimescola</button>
          </div>
          <div class="right controls">
            <button id="toggleEditor" class="ghost">‚úèÔ∏è Editor carte</button>
          </div>
        </div>
      </div>

      <aside class="side">
        <div class="players" id="players"></div>
        <div class="row" style="margin-top:8px">
          <input id="playerInput" type="text" placeholder="Aggiungi giocatore e Invio" />
          <button id="clearPlayers" class="ghost">üßπ Pulisci</button>
        </div>

        <details id="editorPanel">
          <summary>Editor carte (avanzato)</summary>
          <div class="editor">
            <p class="muted">Una carta per riga. Puoi salvare e le modifiche resteranno in questo dispositivo (localStorage). Puoi anche esportare/importare un file .json da condividere.</p>
            <textarea id="cardsTextarea"></textarea>
            <div class="row">
              <button id="saveCards" class="good">üíæ Salva carte</button>
              <button id="resetCards" class="ghost">‚ôªÔ∏è Ripristina predefinite</button>
            </div>
            <div class="row">
              <button id="exportCards" class="ghost">‚¨áÔ∏è Esporta .json</button>
              <input type="file" id="importFile" accept="application/json" style="display:none" />
              <button id="importCards" class="ghost">‚¨ÜÔ∏è Importa .json</button>
            </div>
          </div>
        </details>

        <details>
          <summary>Come si gioca</summary>
          <ul>
            <li>Inserisci i nomi dei giocatori (opzionale).</li>
            <li>Premi <strong>‚ÄúPesca carta‚Äù</strong>. Il turno passa automaticamente al prossimo giocatore.</li>
            <li>Il mazzo √® mescolato casualmente e viene rimescolato quando finisce.</li>
            <li>Puoi modificare le carte dall‚Äôeditor e salvare.</li>
          </ul>
        </details>
      </aside>
    </section>
  </main>

  <footer>
    Fatto con ‚ù§Ô∏è per Elisa. Suggerimento: per condividerlo online carica questo file su Netlify o GitHub Pages.
  </footer>

  <script>
    const DEFAULT_CARDS = [
      "Tutti brindano per Elisa! üçæ",
      "Racconta un ricordo universitario o bevi 2 sorsi.",
      "Gioca ‚ÄúIo non ho mai‚Äù a tema universit√† (1 sorso per chi ha fatto ci√≤).",
      "Chi ha la foto pi√π imbarazzante di Elisa vince! Distribuisci 3 sorsi.",
      "Scegli una regola folle valida per tutti fino al prossimo Joker.",
      "Bevi 1 se hai mai copiato durante un esame.",
      "Elisa sceglie qualcuno che deve imitare un professore o bere.",
      "Nomina tre esami del corso in 10 secondi o bevi 2.",
      "Chi ha aiutato Elisa con la tesi beve con lei.",
      "Fai un brindisi dicendo una qualit√† di Elisa.",
      "Mostra la tua foto universitaria pi√π buffa o bevi.",
      "Tutti quelli che hanno mai saltato una lezione bevono 1.",
      "Racconta la tua peggior giornata d‚Äôesame o bevi.",
      "Chi √® arrivato pi√π tardi oggi beve 2.",
      "Elisa sceglie qualcuno che deve ballare 30 secondi o bere 2.",
      "Bevi 1 se hai mai studiato tutta la notte.",
      "Canta la canzone che ti ricorda l‚Äôuniversit√† o bevi.",
      "Tutti quelli che hanno conosciuto Elisa in un modo assurdo bevono 1.",
      "Chi ha mai fatto Erasmus beve 2.",
      "Chi indovina il titolo della tesi di Elisa fa bere 2 persone.",
      "Fai un complimento ad Elisa o bevi 1.",
      "Bevi 1 se hai mai pianto per un voto.",
      "Elisa sceglie chi deve bere 3 sorsi.",
      "Mostra la tua ultima foto con Elisa. Chi non ne ha, beve.",
      "Tutti quelli che hanno lavorato con Elisa bevono insieme.",
      "Bevi 2 se hai mai fatto una presentazione disastrosa.",
      "Crea una regola: fino al prossimo turno nessuno pu√≤ dire ‚Äúlaurea‚Äù.",
      "Chi √® nato prima di Elisa beve 1, chi dopo 2.",
      "Sfida: imita Elisa per 20 secondi! Chi non ride sceglie chi beve.",
      "Elisa sceglie qualcuno che deve raccontare un ricordo comune.",
      "Bevi 1 se hai mai confuso la data di un esame.",
      "Chi ha fatto pi√π brindisi stasera beve 1 in pi√π.",
      "Gioco rapido: ‚ÄúChi √® pi√π probabile che‚Ä¶‚Äù ‚Äì Elisa sceglie la vittima, che beve.",
      "Tutti quelli con gli occhiali bevono 1.",
      "Bevi 1 se hai mai sbagliato mail al professore.",
      "Racconta un aneddoto divertente con Elisa o bevi 2.",
      "Elisa assegna 5 sorsi totali come vuole.",
      "Crea un brindisi originale per la nuova dottoressa.",
      "Tutti quelli che hanno assistito alla discussione bevono 1.",
      "Bevi 1 se hai mai perso una chiavetta USB con la tesi.",
      "Elisa sceglie qualcuno che deve fare una dedica o bere.",
      "Cita una frase tipica di Elisa, o bevi 2.",
      "Chi ha portato il regalo pi√π piccolo beve 1.",
      "Elisa pu√≤ scegliere di saltare questa carta o farla fare a qualcun altro.",
      "Chi non ha ancora bevuto negli ultimi 5 minuti, beve ora.",
      "Tutti bevono un sorso in onore della nuova dottoressa! üéì",
      "Gioco ‚Äúflash‚Äù: chi ha pi√π foto con Elisa sceglie chi beve.",
      "Elisa sceglie qualcuno che deve raccontare come l‚Äôha conosciuta.",
      "JOKER! Tutti bevono 1 e si scambiano i drink a sinistra.",
      "JOKER! Tutti devono dire ‚ÄúDottoressa Elisa‚Äù prima di bere ogni volta, fino al prossimo Joker."
    ];

    const cardEl = document.getElementById('card');
    const cardText = document.getElementById('cardText');
    const cardIndex = document.getElementById('cardIndex');
    const btnDraw = document.getElementById('draw');
    const btnUndo = document.getElementById('undo');
    const btnReshuffle = document.getElementById('reshuffle');
    const btnFull = document.getElementById('btn-full');
    const playersWrap = document.getElementById('players');
    const playerInput = document.getElementById('playerInput');
    const clearPlayers = document.getElementById('clearPlayers');

    const editorPanel = document.getElementById('editorPanel');
    const toggleEditor = document.getElementById('toggleEditor');
    const cardsTextarea = document.getElementById('cardsTextarea');
    const saveCards = document.getElementById('saveCards');
    const resetCards = document.getElementById('resetCards');
    const exportCards = document.getElementById('exportCards');
    const importCards = document.getElementById('importCards');
    const importFile = document.getElementById('importFile');

    const LS_KEY = 'drink_degree_elisa_cards_v1';
    const LS_PLAYERS = 'drink_degree_elisa_players_v1';

    let deck = [];
    let order = [];
    let pointer = -1; // indice della carta corrente nell'ordine
    let history = []; // per "indietro"

    function loadCards(){
      let stored = null;
      try { stored = JSON.parse(localStorage.getItem(LS_KEY)); } catch(e){}
      const cards = Array.isArray(stored) && stored.length ? stored : DEFAULT_CARDS.slice();
      cardsTextarea.value = cards.join("\n");
      return cards;
    }

    function saveCardsToLS(cards){
      localStorage.setItem(LS_KEY, JSON.stringify(cards));
    }

    function getCurrentCards(){
      return cardsTextarea.value
        .split(/\n/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function buildDeck(){
      deck = loadCards();
      order = shuffle([...deck.keys()]);
      pointer = -1;
      history = [];
      updateCardUI("Premi ‚ÄúPesca carta‚Äù per iniziare ‚ú®", '‚Äî');
    }

    function updateCardUI(text, idx){
      cardText.textContent = text;
      cardIndex.textContent = idx;
      cardEl.animate([
        { transform: 'scale(.99)', opacity: .96},
        { transform: 'scale(1)', opacity: 1}
      ], { duration: 140, easing: 'ease-out'});
    }

    function drawCard(){
      if(pointer + 1 >= order.length){
        updateCardUI('Mazzo terminato. Premi ‚ÄúRimescola‚Äù per ricominciare. üîÑ', '‚Äî');
        return;
      }
      pointer += 1;
      history.push(pointer);
      const deckIndex = order[pointer];
      updateTurnChip();
      updateCardUI(deck[deckIndex], `${pointer+1}/${order.length}`);
    }

    function undoCard(){
      if(history.length <= 1){ // prima carta o niente
        pointer = -1; history = [];
        updateCardUI('Premi ‚ÄúPesca carta‚Äù per iniziare ‚ú®', '‚Äî');
        return;
      }
      history.pop();
      pointer = history[history.length-1];
      const deckIndex = order[pointer];
      updateTurnChip(true);
      updateCardUI(deck[deckIndex], `${pointer+1}/${order.length}`);
    }

    function reshuffle(){
      order = shuffle([...deck.keys()]);
      pointer = -1; history = [];
      updateCardUI('Mazzo mescolato. Via! üé≤', '‚Äî');
    }

    // Gestione giocatori & turni
    let players = [];
    let turn = 0; // indice del giocatore di turno

    function loadPlayers(){
      try{ const p = JSON.parse(localStorage.getItem(LS_PLAYERS)); if(Array.isArray(p)) players = p; }catch(e){}
      renderPlayers();
    }
    function savePlayers(){ localStorage.setItem(LS_PLAYERS, JSON.stringify(players)); }

    function renderPlayers(){
      playersWrap.innerHTML = '';
      players.forEach((name,i)=>{
        const chip = document.createElement('span');
        chip.className = 'player-chip' + (i===turn?' active':'');
        chip.textContent = name || `Giocatore ${i+1}`;
        chip.title = 'Clicca per rimuovere';
        chip.onclick = ()=>{ players.splice(i,1); if(turn>=players.length) turn=0; savePlayers(); renderPlayers(); };
        playersWrap.appendChild(chip);
      });
      if(players.length===0){
        const hint=document.createElement('span');
        hint.className='muted';
        hint.textContent='Suggerimento: aggiungi i giocatori per evidenziare il turno.';
        playersWrap.appendChild(hint);
      }
    }

    function nextTurn(){ if(players.length){ turn = (turn+1) % players.length; renderPlayers(); } }
    function prevTurn(){ if(players.length){ turn = (turn-1+players.length) % players.length; renderPlayers(); } }
    function updateTurnChip(reverse=false){ reverse ? prevTurn() : nextTurn(); }

    // Fullscreen helper
    btnFull.addEventListener('click', async()=>{
      const el = document.documentElement;
      if(!document.fullscreenElement){ await el.requestFullscreen?.(); } else { await document.exitFullscreen?.(); }
    });

    // Editor handlers
    toggleEditor.addEventListener('click', ()=>{ editorPanel.open = !editorPanel.open; });
    saveCards.addEventListener('click', ()=>{
      const cards = getCurrentCards();
      if(!cards.length){ alert('Inserisci almeno una carta.'); return; }
      saveCardsToLS(cards); deck = cards.slice(); reshuffle(); alert('Carte salvate. Mazzo rimescolato.');
    });
    resetCards.addEventListener('click', ()=>{
      cardsTextarea.value = DEFAULT_CARDS.join("\n");
      saveCardsToLS(DEFAULT_CARDS); deck = DEFAULT_CARDS.slice(); reshuffle();
    });

    exportCards.addEventListener('click', ()=>{
      const data = JSON.stringify(getCurrentCards(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='drink_degree_elisa_carte.json'; a.click();
      URL.revokeObjectURL(url);
    });
    importCards.addEventListener('click', ()=> importFile.click());
    importFile.addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const arr = JSON.parse(reader.result);
          if(!Array.isArray(arr) || !arr.length) throw new Error('Formato non valido');
          cardsTextarea.value = arr.join("\n"); saveCardsToLS(arr); deck = arr.slice(); reshuffle();
          alert('Carte importate e salvate.');
        }catch(err){ alert('Import non riuscito: ' + err.message); }
      };
      reader.readAsText(file);
    });

    // Deck buttons
    btnDraw.addEventListener('click', drawCard);
    btnUndo.addEventListener('click', undoCard);
    btnReshuffle.addEventListener('click', reshuffle);

    // Tastiera rapida: spazio = pesca, backspace = indietro, r = rimescola
    window.addEventListener('keydown', (e)=>{
      if(['INPUT','TEXTAREA'].includes(document.activeElement?.tagName)) return;
      if(e.code==='Space'){ e.preventDefault(); drawCard(); }
      if(e.code==='Backspace'){ e.preventDefault(); undoCard(); }
      if(e.key?.toLowerCase()==='r'){ reshuffle(); }
    });

    // Players handlers
    playerInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        const name = playerInput.value.trim();
        if(name){ players.push(name); savePlayers(); renderPlayers(); playerInput.value=''; }
      }
    });
    clearPlayers.addEventListener('click', ()=>{ players=[]; savePlayers(); renderPlayers(); });

    // Boot
    (function init(){
      loadPlayers();
      buildDeck(); // carica da LS o default e mescola
      // Avvio estetico: breve animazione
      cardEl.animate([{opacity:0, transform:'translateY(6px)'},{opacity:1, transform:'translateY(0)'}], {duration:350, easing:'ease-out'});
    })();
  </script>
</body>
</html>
